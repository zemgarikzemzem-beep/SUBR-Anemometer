#include "i2c.h"
#include "gpio.h"

void I2C1_Init(void){
	RCC->APB1ENR1|=RCC_APB1ENR1_I2C1EN;
	RCC->CCIPR|=RCC_CCIPR_I2C1SEL_0;
	
	GPIOB->MODER&=~0x0000F000;           // (B6,B7) Alternate open drain high speed
	GPIOB->MODER|=((GPIO_MODE_ALTERNATE<<(6<<1))|(GPIO_MODE_ALTERNATE<<(7<<1)));
	GPIOB->OTYPER|=((GPIO_OUTPUT_OPENDRAIN<<6)|(GPIO_OUTPUT_OPENDRAIN<<7));
	GPIOB->OSPEEDR|=((GPIO_SPEED_FREQ_VERY_HIGH<<(6<<1))|(GPIO_SPEED_FREQ_VERY_HIGH<<(7<<1)));
	GPIOB->PUPDR|=((GPIO_PULL_NO<<(6<<1))|(GPIO_PULL_NO<<(7<<1)));
	GPIOB->AFR[0]=0x44000000;
	
	I2C1->CR1=0;
	I2C1->CR2=0;
	I2C1->CR2|=I2C_CR2_AUTOEND;
	I2C1->OAR1=I2C_OAR1_OA1EN;
	I2C1->TIMINGR=0xB0420F13;  // RefMan стр. 1145 TIMINGR configuration examples
}

void LCD_WriteByteI2CLCD (uint8_t b){
	
	I2C1->CR1|=I2C_CR1_PE;
	I2C1->CR2=0;
	I2C1->TXDR = b;
	I2C1->CR2|=(I2C_CR2_AUTOEND|(0x4E<<(I2C_CR2_SADD_Pos))|(1<<I2C_CR2_NBYTES_Pos)|I2C_CR2_START);  // 0x4E - адрес устройства
	while(!(I2C1->ISR&I2C_ISR_STOPF));
	I2C1->ICR=I2C_ICR_STOPCF;
	I2C1->CR1&=~I2C_CR1_PE;
}
